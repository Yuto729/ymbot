# Moltbot アーキテクチャ概要

## 全体像

Moltbotは**カスタムシステムプロンプト**を動的に組み立て、エージェントに提供するアーキテクチャを採用しています。

```
┌─────────────────────────────────────────────────┐
│              Moltbot Architecture                │
└─────────────────────────────────────────────────┘

         ┌──────────────────┐
         │  User Request    │
         └────────┬─────────┘
                  ↓
         ┌──────────────────┐
         │  Prompt Builder  │ ← システムプロンプトを組み立て
         └────────┬─────────┘
                  ↓
    ┌─────────────────────────────────┐
    │     System Prompt (Compact)     │
    │  - Fixed sections               │
    │  - Bootstrap files injected     │
    │  - Skills references only       │
    └─────────────┬───────────────────┘
                  ↓
         ┌──────────────────┐
         │  Agent Runtime   │ ← LLM実行
         └────────┬─────────┘
                  ↓
         ┌──────────────────┐
         │   Tool Calls     │ ← 必要に応じてスキル読み込み
         └────────┬─────────┘
                  ↓
         ┌──────────────────┐
         │    Response      │
         └──────────────────┘
```

## 階層構造

### 1. システムプロンプト層

**役割**: エージェントの「憲法」を定義

- 利用可能なツール
- スキルの参照リスト（フルコンテンツは含まない）
- ワークスペース情報
- 実行環境情報

**特徴**:
- コンパクト（トークン削減）
- キャッシュ可能（動的値を避ける）
- 固定セクション構造

### 2. ブートストラップ層

**役割**: エージェントの「人格」と「コンテキスト」を提供

自動注入されるファイル：
```
SOUL.md      - コア価値観・ペルソナ
IDENTITY.md  - アイデンティティ
AGENTS.md    - 操作ルール
USER.md      - ユーザーコンテキスト
HEARTBEAT.md - 定期チェック項目
TOOLS.md     - ツール定義（オプション）
```

**特徴**:
- ファイルごとに最大20,000文字（設定可能）
- 大きすぎる場合は切り詰め
- 欠けているファイルはマーカー注入

### 3. オンデマンド層

**役割**: 必要な時だけ追加情報を取得

- **スキル**: `read` ツールで SKILL.md を読み込み
- **ドキュメント**: 必要に応じてローカルdocsを参照
- **動的情報**: `session_status` で現在時刻などを取得

**特徴**:
- システムプロンプトを肥大化させない
- キャッシュ効率を保つ
- 段階的な情報取得

### 4. 自動化層

**役割**: 定期実行とスケジューリング

- **Heartbeat**: 定期的な監視と通知（30分ごとなど）
- **Cron**: 正確なタイミングでのタスク実行

## プロンプトモード

Moltbotは状況に応じて異なるサイズのプロンプトを生成します：

| モード | 用途 | 含まれるセクション |
|--------|------|------------------|
| `full` | メインエージェント | 全セクション |
| `minimal` | サブエージェント | Tooling, Workspace, Runtime のみ |
| `none` | 最小限 | アイデンティティ行のみ |

**minimal モードで省略されるもの**:
- Skills
- Memory Recall
- Self-Update
- User Identity
- Reply Tags
- Heartbeats

これにより、サブエージェントは軽量に保たれます。

## 情報フロー詳細

```
┌──────────────────────────────────────────────────┐
│ Phase 1: Prompt Assembly                         │
├──────────────────────────────────────────────────┤
│                                                  │
│  1. 固定セクション生成                           │
│     - Tooling                                    │
│     - Workspace                                  │
│     - Runtime                                    │
│                                                  │
│  2. ブートストラップファイル注入                 │
│     - SOUL.md, IDENTITY.md, etc.                │
│     - トリミング（20,000文字制限）               │
│                                                  │
│  3. スキル参照リスト追加                         │
│     - 名前、説明、ファイルパスのみ               │
│                                                  │
│  4. 完成したプロンプト → LLMへ                   │
│                                                  │
└──────────────────────────────────────────────────┘
                       ↓
┌──────────────────────────────────────────────────┐
│ Phase 2: Agent Execution                         │
├──────────────────────────────────────────────────┤
│                                                  │
│  1. LLMがプロンプトを処理                        │
│                                                  │
│  2. 必要に応じてツール呼び出し                   │
│     - read ~/skills/gmail/SKILL.md              │
│     - session_status (for current time)         │
│                                                  │
│  3. ツール結果を元に処理継続                     │
│                                                  │
│  4. 最終応答生成                                 │
│                                                  │
└──────────────────────────────────────────────────┘
                       ↓
┌──────────────────────────────────────────────────┐
│ Phase 3: Automation (Optional)                   │
├──────────────────────────────────────────────────┤
│                                                  │
│  Heartbeat (30分ごと):                           │
│  - HEARTBEAT.md読み込み                          │
│  - チェック項目実行                              │
│  - 必要なら通知                                  │
│                                                  │
│  Cron (指定時刻):                                │
│  - 正確なタイミングで実行                        │
│  - 隔離セッション可能                            │
│                                                  │
└──────────────────────────────────────────────────┘
```

## 設計原則

### 1. コンパクト性優先

**なぜ**: トークンコストを削減し、応答速度を向上

**どうやって**:
- スキルは参照のみ（フルコンテンツは注入しない）
- 動的情報はツールで取得（プロンプトに含めない）
- 固定セクション構造

### 2. キャッシュ効率

**なぜ**: プロンプトキャッシュでコストと速度を最適化

**どうやって**:
- 動的な値（現在時刻など）を避ける
- タイムゾーンのみ含める（時刻は`session_status`で）
- スキル変更時もプロンプトは不変

### 3. 段階的読み込み

**なぜ**: 必要な情報だけを取得し、不要なトークンを削減

**どうやって**:
```
System Prompt（コンパクト）
    ↓
スキル一覧を見る
    ↓
必要なスキルをread
    ↓
実行
```

### 4. 柔軟性

**なぜ**: 異なるユースケースに対応

**どうやって**:
- プロンプトモード（full/minimal/none）
- パーエージェント設定
- フック機構で注入内容をカスタマイズ

## コンポーネント間の関係

```
┌─────────────────────────────────────────────────┐
│              Configuration                       │
│  (agents.defaults, workspace settings)           │
└────────────┬────────────────────────────────────┘
             ↓
┌─────────────────────────────────────────────────┐
│           Prompt Builder                         │
│  - Read bootstrap files                          │
│  - Format skills list                            │
│  - Assemble sections                             │
└────────────┬────────────────────────────────────┘
             ↓
┌─────────────────────────────────────────────────┐
│         Agent Runtime                            │
│  - Execute with system prompt                    │
│  - Handle tool calls                             │
│  - Manage sessions                               │
└────────────┬────────────────────────────────────┘
             ↓
┌─────────────────────────────────────────────────┐
│       Automation Runtime                         │
│  - Heartbeat scheduler                           │
│  - Cron scheduler                                │
│  - Event queue                                   │
└─────────────────────────────────────────────────┘
```

## 次のステップ

- [システムプロンプト設計](./system-prompt.md) - プロンプト構造の詳細
- [ブートストラップ注入](./bootstrap-injection.md) - ファイル注入の仕組み
- [Heartbeat機能](../features/heartbeat.md) - 自動化の中核

## キーポイント

```
★ Moltbotの3つの革新
  1. コンパクトなシステムプロンプト → トークン削減
  2. オンデマンドスキル読み込み → スケーラビリティ
  3. Heartbeat自動化 → バッチ効率
```
